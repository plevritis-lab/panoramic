---
title: "PANORAMIC tutorial"
vignette: >
  %\VignetteIndexEntry{PANORAMIC tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


# Introduction
Spatial transcriptomics experiments increasingly profile multiple samples across conditions, yet most statistical methods still perform colocalization analysis sample by sample, or rely on ad hoc aggregation of summary measures. The panoramic package (Pooled ANalysis Of vaRiance-aware Modeling and Inference of Colocalization) provides a principled meta-analytic framework for pooling spatial colocalization statistics across many samples while accounting for within-sample uncertainty and between-sample heterogeneity.

PANORAMIC takes as input a collection of spatial omics samples, represented as SpatialExperiment objects, and computes spatial summary statistics (such as L-functions) for all pairs of cell types at user-specified radii. These summaries are then modeled using random-effects meta-analysis, enabling robust estimation of group-level spatial associations and formal testing of differences between biological conditions.

Compared to existing tools that focus on single-sample spatial statistics or descriptive visualizations, PANORAMIC emphasizes pooled inference across experiments, explicit modeling of variance, and reproducible meta-analytic summaries of spatial colocalization. This makes it particularly well suited for multi-sample, multi-cohort spatial studies where rigorous cross-sample inference is required.

```{r}
# Installation 
# devtools::install_github("plevritis-lab/panoramic")
```


```{r}
library(panoramic)
library(SpatialExperiment)
library(dplyr)
library(SpatialExperiment)
library(S4Vectors)
library(BiocParallel)
library(ggplot2)

set.seed(123)
```

```{r}
# Helper: turn a data.frame into a SpatialExperiment -----------------------
df_to_spe <- function(df) {
  stopifnot(all(c("sample", "x", "y", "cell_type") %in% colnames(df)))

  coords <- as.matrix(df[, c("x", "y")])
  rownames(coords) <- paste0(df$sample, "_cell", seq_len(nrow(df)))

  # dummy counts (not used by PANORAMIC)
  expr <- matrix(
    rpois(10 * nrow(df), lambda = 5),
    nrow = 10,
    dimnames = list(paste0("gene", seq_len(10)), rownames(coords))
  )

  SpatialExperiment::SpatialExperiment(
    assays = list(counts = expr),
    colData = S4Vectors::DataFrame(
      cell_type = df$cell_type,
      sample_id = df$sample
    ),
    spatialCoords = coords
  )
}

# Simulate group 1 ---------------------------------------------------------
group1_spe_list <- list()

for (i in 1:3) {
  n <- round(rnorm(n = 1, mean = 200, sd = 100))
  n <- max(n, 50)  # ensure positive / nontrivial

  x <- runif(n = n, min = 0, max = 100)
  y <- runif(n = n, min = 0, max = 100)
  cell_type <- sample(
    x = c("(A)", "(B)", "(C)"),
    size = n,
    replace = TRUE
  )

  df <- data.frame(
    sample    = paste0("sample_", i),
    x         = x,
    y         = y,
    cell_type = cell_type,
    stringsAsFactors = FALSE
  )

  group1_spe_list[[i]] <- df_to_spe(df)
}

names(group1_spe_list) <- paste0("sample_", 1:3)

# Simulate group 2 ---------------------------------------------------------
group2_spe_list <- list()

for (j in 1:3) {
  n <- round(rnorm(n = 1, mean = 400, sd = 100))
  n <- max(n, 50)

  x <- rnorm(n = n, mean = 50, sd = 20)
  y <- rnorm(n = n, mean = 50, sd = 20)
  cell_type <- sample(
    x = c("(A)", "(B)", "(C)"),
    size = n,
    replace = TRUE
  )

  df <- data.frame(
    sample    = paste0("sample_", j + 3),
    x         = x,
    y         = y,
    cell_type = cell_type,
    stringsAsFactors = FALSE
  ) |>
    dplyr::filter(dplyr::between(x, 0, 100) & dplyr::between(y, 0, 100))

  group2_spe_list[[j]] <- df_to_spe(df)
}

names(group2_spe_list) <- paste0("sample_", 4:6)

# Combine into one list for PANORAMIC -------------------------------------
spe_list <- c(group1_spe_list, group2_spe_list)

# Design data.frame mapping samples to groups ------------------------------
design <- data.frame(
  sample = paste0("sample_", 1:6),
  group  = c(rep("group1", 3), rep("group2", 3)),
  stringsAsFactors = FALSE
)

```

```{r}
plot_df <- do.call(rbind, lapply(spe_list, function(spe) {
  coords <- SpatialExperiment::spatialCoords(spe)
  df <- as.data.frame(coords)
  df$cell_type <- colData(spe)$cell_type
  df$sample_id <- colData(spe)$sample_id
  df
}))

ggplot(plot_df, aes(x = x, y = y, color = cell_type)) +
  geom_point(size = 0.7, alpha = 0.7) +
  facet_wrap(~ sample_id, nrow = 2) +
  coord_equal() +
  theme_bw() +
  labs(x = "x", y = "y", color = "Cell type")


```

```{r}
se <- panoramic(
  spe_list,
  design      = design,
  cell_type   = "cell_type",
  radii_um    = c(10),
  stat        = "Lcross",
  nsim        = 50,
  BPPARAM     = BiocParallel::SerialParam()
)

se_meta <- panoramic_meta(se, tau2 = "SJ", group_col = "group")
se_diff <- panoramic_compare_groups(se_meta, group1 = "group1", group2 = "group2")

```

```{r}
# Inspect the meta-analysis outputs for a pair of cell-types
plot_forest(se_meta, 
            ct1 = "(A)", 
            ct2 = "(B)", 
            show_heterogeneity = TRUE)
```



```{r}
# Inspect the significant results after FDR correction 
res <- as.data.frame(rowData(se_diff))
res |> filter(fdr_diff < 0.05)
```
```{r}
# Visualize the results as a volcano-plot 
# NOTE: this volcano plot is strange looking because only group2 displayed higher 
# colocalization betweeen various pairs of cell types. 
plot_volcano(se_diff)
```
```{r}
net <- create_spatial_network(se_diff,
                              fdr_threshold = 0.9,
                              directed = FALSE, 
                              leiden_resolution = 1.0)
plot_spatial_network(net,
                     layout = "fr",
                     node_size_by = "degree") 

```

```{r}
sessionInfo()
```

