% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/panoramic-meta.R
\name{panoramic_meta}
\alias{panoramic_meta}
\title{Random-effects meta-analysis of PANORAMIC features
Perform feature-wise random-effects meta-analysis on PANORAMIC spatial
statistics, optionally estimating separate between-sample variances
(\eqn{\tau^2}) per group, which is recommended. Pooled estimates and diagnostics are written
into \code{rowData(se)}.}
\usage{
panoramic_meta(
  se,
  tau2 = c("SJ", "REML", "DL"),
  group_col = NULL,
  BPPARAM = BiocParallel::SerialParam()
)
}
\arguments{
\item{se}{A \code{SummarizedExperiment} produced by
\code{panoramic_spatialstats()} or \code{panoramic()}, containing
assays \code{"yi"} (effect estimates) and \code{"vi"} (within-sample variances) for each feature (ct1, ct2, radius) and sample.}

\item{tau2}{Character. Estimator for the between-sample variance \eqn{\tau^2}. One of \code{"SJ"} (Sidik-Jonkman), \code{"REML"},
or \code{"DL"} (DerSimonian-Laird), passed to \code{metafor::rma.uni()}.}

\item{group_col}{Optional character scalar giving the name of a column
in \code{colData(se)} that defines groups (e.g. treatment) for
group-specific pooling. If \code{NULL}, a single meta-analysis is
fitted across all samples for each feature.}

\item{BPPARAM}{A \code{BiocParallelParam} object controlling
parallelization across features (rows). Defaults to
\code{BiocParallel::SerialParam()}.}
}
\value{
The input \code{SummarizedExperiment}, with additional columns appended to \code{rowData(se)}:
\itemize{
\item If \code{group_col} is \code{NULL}, columns:
\code{mu_hat}, \code{se_mu}, \code{tau2}, \code{Q}, \code{I2}, \code{k}, \code{p_mu}.
\item If \code{group_col} is provided, the same set of columns
is created per group, prefixed by a group label, e.g. \code{GroupA_mu_hat}, etc.
}
PANORAMIC meta-analysis settings are also stored in
\code{metadata(se)$panoramix$meta}.
}
\description{
Random-effects meta-analysis of PANORAMIC features
Perform feature-wise random-effects meta-analysis on PANORAMIC spatial
statistics, optionally estimating separate between-sample variances
(\eqn{\tau^2}) per group, which is recommended. Pooled estimates and diagnostics are written
into \code{rowData(se)}.
}
\details{
For each feature (cell-type pair and radius), the function fits a
univariate random-effects model via \code{metafor::rma.uni()}, using
the supplied \code{yi} and \code{vi} across samples. Features with
fewer than 2 finite observations (and positive variances) receive
\code{NA} for all meta-analytic quantities.

When \code{group_col} is supplied, separate random-effects models are
fitted within each group level, producing group-specific pooled
effects and heterogeneity statistics. This supports differential
colocalization analysis across biological conditions.
}
\examples{
library(SpatialExperiment)
library(S4Vectors)
library(BiocParallel)

set.seed(1)

make_spe <- function(n_cells, sample_id) {
  coords <- cbind(
    x = runif(n_cells, 0, 100),
    y = runif(n_cells, 0, 100)
  )
  ct <- sample(c("A", "B"), size = n_cells, replace = TRUE)

  counts <- matrix(
    rpois(5 * n_cells, lambda = 5),
    nrow = 5,
    dimnames = list(
      paste0("gene", seq_len(5)),
      paste0(sample_id, "_cell", seq_len(n_cells))
    )
  )

  SpatialExperiment::SpatialExperiment(
    assays = list(counts = counts),
    colData = S4Vectors::DataFrame(
      cell_type = ct,
      sample_id = sample_id
    ),
    spatialCoords = coords
  )
}

spe1 <- make_spe(20, "sample1")
spe2 <- make_spe(22, "sample2")

spe_list <- list(sample1 = spe1, sample2 = spe2)

design <- data.frame(
  sample = c("sample1", "sample2"),
  group  = c("group1", "group2"),
  stringsAsFactors = FALSE
)

# Compute spatial statistics across samples
se_stats <- panoramic(
  spe_list,
  design      = design,
  cell_type   = "cell_type",
  radii_um    = c(10, 20),
  stat        = "Lcross",
  nsim        = 5,
  correction  = "translate",
  min_cells   = 2,
  concavity   = 50,
  window      = "rect",
  seed        = 1,
  BPPARAM     = BiocParallel::SerialParam()
)

# Global random-effects meta-analysis
se_meta_global <- panoramic_meta(se_stats, tau2 = "SJ")

# Group-specific meta-analysis by 'group'
se_meta_group <- panoramic_meta(se_stats, tau2 = "SJ", group_col = "group")

}
